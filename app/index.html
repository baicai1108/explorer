<!DOCTYPE html>
<html lang="en" ng-app="ethExplorer">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§æœ‰é“¾æµè§ˆå™¨</title>
    <meta name="description" content="åŸºäº etherparty/explorer æ”¹é€ çš„ç§æœ‰é“¾æµè§ˆå™¨">
    
    <!-- åœ¨çº¿å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”—</text></svg>">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css">
    
    <style>
        body { 
            padding-top: 70px; 
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
        }
        .navbar-fixed-top { 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1030; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .status-indicator { 
            display: inline-block; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            margin-right: 5px; 
        }
        .connected { background-color: #5cb85c; }
        .disconnected { background-color: #d9534f; }
        .form-control { width: 400px; max-width: 100%; }
        .monospace { font-family: monospace; font-size: 12px; }
        .block-info { margin-top: 20px; }
    </style>
</head>
<body ng-controller="MainController">
  
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a href="#" class="navbar-brand" ng-click="goHome()">ç§æœ‰é“¾æµè§ˆå™¨</a>
        </div>
        
        <!-- å¯¼èˆªæ çŠ¶æ€ -->
        <div class="navbar-text navbar-left" style="margin-left:15px; color:#ccc; font-size:13px;">
            <span class="status-indicator" ng-class="{'connected': connected, 'disconnected': !connected}"></span>
            åŒºå—: {{blockNumber || '--'}}
        </div>
        
        <div id="navbar" class="navbar-collapse collapse">
            <form name="search_form" ng-submit="search()" class="navbar-form navbar-right">
                <div class="form-group">
                    <input type="text" placeholder="äº¤æ˜“å“ˆå¸Œã€åœ°å€æˆ–åŒºå—å·" 
                           ng-model="searchInput" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">æœç´¢</button>
            </form>
        </div>
    </div>
</nav>

<div class="container">
    <!-- è¿æ¥çŠ¶æ€ -->
    <div class="alert" ng-class="{'alert-success': connected, 'alert-warning': !connected}" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span ng-if="connected">
                    âœ… å·²è¿æ¥åˆ°ç§æœ‰é“¾èŠ‚ç‚¹
                </span>
                <span ng-if="!connected">
                    âš ï¸ æœªè¿æ¥åˆ°ç§æœ‰é“¾èŠ‚ç‚¹
                </span>
                <span style="margin-left: 10px;" ng-if="connected">
                    å½“å‰åŒºå—: <strong>{{blockNumber}}</strong>
                </span>
            </div>
            <button ng-click="checkConnection()" class="btn btn-sm" ng-class="{'btn-success': connected, 'btn-warning': !connected}">
                åˆ·æ–°è¿æ¥
            </button>
        </div>
    </div>
    
    <!-- æœ€æ–°åŒºå—ä¿¡æ¯ -->
    <div class="panel panel-default block-info" ng-if="latestBlock">
        <div class="panel-heading">
            <h3 class="panel-title">æœ€æ–°åŒºå—ä¿¡æ¯</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>åŒºå—é«˜åº¦:</strong> {{latestBlock.number}}</p>
                    <p><strong>çŸ¿å·¥åœ°å€:</strong> <span class="monospace">{{latestBlock.miner}}</span></p>
                    <p><strong>éš¾åº¦:</strong> {{latestBlock.difficulty}}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>äº¤æ˜“æ•°é‡:</strong> {{latestBlock.transactions ? latestBlock.transactions.length : 0}}</p>
                    <p><strong>æ—¶é—´æˆ³:</strong> {{(latestBlock.timestamp * 1000) | date:'yyyy-MM-dd HH:mm:ss'}}</p>
                    <p><strong>Gas é™åˆ¶:</strong> {{latestBlock.gasLimit}}</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <p><strong>åŒºå—å“ˆå¸Œ:</strong> <span class="monospace">{{latestBlock.hash}}</span></p>
                    <p><strong>çˆ¶åŒºå—å“ˆå¸Œ:</strong> <span class="monospace">{{latestBlock.parentHash}}</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŒºå—è¯¦æƒ…é¡µ -->
    <div ng-if="viewMode === 'block'">
        <h2>åŒºå—è¯¦æƒ… #{{currentBlockId}}</h2>
        <div ng-if="blockDetail">
            <pre>{{blockDetail | json}}</pre>
        </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="text-center" ng-if="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">åŠ è½½ä¸­...</span>
        </div>
        <p>åŠ è½½ä¸­...</p>
    </div>
</div>

<!-- é¡µè„š -->
<footer style="margin-top: 40px; padding: 20px 0; background: #2c3e50; color: #ecf0f1;">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <p><strong>ç§æœ‰é“¾æµè§ˆå™¨ v1.0</strong></p>
                <p>åŸºäº etherparty/explorer æ”¹é€ </p>
            </div>
            <div class="col-md-6 text-right">
                <p>èŠ‚ç‚¹: <code>{{nodeUrl}}</code></p>
                <p>çŠ¶æ€: 
                    <span ng-if="connected" style="color: #5cb85c;">â— å·²è¿æ¥</span>
                    <span ng-if="!connected" style="color: #d9534f;">â— æœªè¿æ¥</span>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- ========== æ‰€æœ‰ä¾èµ–ä½¿ç”¨ CDN ========== -->
<!-- jQuery -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<!-- Web3 -->
<script src="https://cdn.jsdelivr.net/npm/web3@0.14.0/dist/web3.min.js"></script>
<!-- AngularJS 1.4.5 -->
<script src="https://cdn.bootcdn.net/ajax/libs/angular.js/1.4.5/angular.min.js"></script>
<!-- Angular Route 1.4.5 -->
<script src="https://cdn.bootcdn.net/ajax/libs/angular.js/1.4.5/angular-route.min.js"></script>

<!-- åº”ç”¨è„šæœ¬ - ç›´æ¥å†…è” -->
<script>
// åº”ç”¨ä¸»è„šæœ¬
(function() {
    'use strict';
    
    console.log('=== ç§æœ‰é“¾æµè§ˆå™¨åˆå§‹åŒ– ===');
    console.log('Angularç‰ˆæœ¬:', angular ? angular.version.full : 'æœªåŠ è½½');
    
    // æ£€æŸ¥æ‰€æœ‰ä¾èµ–
    if (typeof angular === 'undefined') {
        console.error('é”™è¯¯: AngularJS æœªåŠ è½½');
        alert('AngularJS åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
        return;
    }
    
    if (typeof jQuery === 'undefined') {
        console.error('è­¦å‘Š: jQuery æœªåŠ è½½ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™');
    }
    
    if (typeof Web3 === 'undefined') {
        console.error('è­¦å‘Š: Web3 æœªåŠ è½½ï¼ŒåŒºå—é“¾åŠŸèƒ½ä¸å¯ç”¨');
    }
    
    // åˆ›å»ºAngularåº”ç”¨
    var app = angular.module('ethExplorer', ['ngRoute']);
    console.log('Angularæ¨¡å—åˆ›å»ºæˆåŠŸ');
    
    // é…ç½®è·¯ç”±
    app.config(['$routeProvider', function($routeProvider) {
        console.log('é…ç½®è·¯ç”±');
        $routeProvider
            .when('/', {
                template: '', // ä½¿ç”¨å†…è”æ¨¡æ¿
                controller: 'MainController'
            })
            .otherwise({
                redirectTo: '/'
            });
    }]);
    
    // ä¸»æ§åˆ¶å™¨
    app.controller('MainController', ['$scope', '$http', '$timeout', '$location',
        function($scope, $http, $timeout, $location) {
            console.log('MainController åˆå§‹åŒ–');
            
            // åˆå§‹åŒ–å˜é‡
            $scope.connected = false;
            $scope.blockNumber = 0;
            $scope.searchInput = '';
            $scope.latestBlock = null;
            $scope.loading = false;
            $scope.viewMode = 'home';
            $scope.nodeUrl = 'http://localhost:8545';
            $scope.web3 = null;
            
            // åˆå§‹åŒ–Web3
            if (typeof Web3 !== 'undefined') {
                try {
                    $scope.web3 = new Web3(new Web3.providers.HttpProvider($scope.nodeUrl));
                    console.log('Web3åˆå§‹åŒ–æˆåŠŸ');
                } catch (e) {
                    console.warn('Web3åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }
            
            // æ£€æŸ¥è¿æ¥
            $scope.checkConnection = function() {
                console.log('æ£€æŸ¥ç§æœ‰é“¾è¿æ¥...');
                $scope.loading = true;
                
                $http({
                    method: 'POST',
                    url: $scope.nodeUrl,
                    data: {
                        jsonrpc: "2.0",
                        method: "eth_blockNumber",
                        params: [],
                        id: 1
                    },
                    timeout: 5000
                }).then(function(response) {
                    console.log('RPCå“åº”:', response.data);
                    
                    if (response.data && response.data.result) {
                        var blockNum = parseInt(response.data.result, 16);
                        $scope.connected = true;
                        $scope.blockNumber = blockNum;
                        $scope.loading = false;
                        
                        console.log('âœ… è¿æ¥æˆåŠŸï¼ŒåŒºå—é«˜åº¦:', blockNum);
                        
                        // è·å–æœ€æ–°åŒºå—
                        $scope.getLatestBlock();
                    } else {
                        throw new Error('æ— æ•ˆçš„RPCå“åº”');
                    }
                }).catch(function(error) {
                    console.error('âŒ è¿æ¥å¤±è´¥:', error);
                    $scope.connected = false;
                    $scope.loading = false;
                    
                    // æ˜¾ç¤ºè¿æ¥è­¦å‘Š
                    $scope.showConnectionAlert();
                });
            };
            
            // è·å–æœ€æ–°åŒºå—
            $scope.getLatestBlock = function() {
                if (!$scope.web3) {
                    console.log('Web3æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è·å–åŒºå—');
                    return;
                }
                
                console.log('è·å–æœ€æ–°åŒºå—...');
                $scope.web3.eth.getBlock('latest', function(error, block) {
                    if (error) {
                        console.error('è·å–åŒºå—å¤±è´¥:', error);
                        return;
                    }
                    
                    $scope.$apply(function() {
                        $scope.latestBlock = block;
                        console.log('è·å–åˆ°åŒºå—:', block.number);
                    });
                });
            };
            
            // æœç´¢åŠŸèƒ½
            $scope.search = function() {
                if (!$scope.searchInput || $scope.searchInput.trim() === '') {
                    alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                    return;
                }
                
                var input = $scope.searchInput.trim();
                console.log('æœç´¢:', input);
                
                // åˆ¤æ–­æœç´¢ç±»å‹
                if (input.startsWith('0x')) {
                    if (input.length === 66) {
                        // äº¤æ˜“å“ˆå¸Œ
                        alert('æŸ¥çœ‹äº¤æ˜“: ' + input);
                        $scope.viewBlock(input);
                    } else if (input.length === 42) {
                        // åœ°å€
                        alert('æŸ¥çœ‹åœ°å€: ' + input);
                        $scope.viewAddress(input);
                    } else {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“å“ˆå¸Œï¼ˆ66å­—ç¬¦ï¼‰æˆ–åœ°å€ï¼ˆ42å­—ç¬¦ï¼‰');
                    }
                } else if (/^\d+$/.test(input)) {
                    // åŒºå—å·
                    $scope.viewBlock(input);
                } else {
                    alert('è¯·è¾“å…¥äº¤æ˜“å“ˆå¸Œã€åœ°å€æˆ–åŒºå—å·');
                }
                
                $scope.searchInput = '';
            };
            
            // æŸ¥çœ‹åŒºå—
            $scope.viewBlock = function(blockId) {
                console.log('æŸ¥çœ‹åŒºå—:', blockId);
                $scope.viewMode = 'block';
                $scope.currentBlockId = blockId;
                $scope.blockDetail = null;
                $scope.loading = true;
                
                $http({
                    method: 'POST',
                    url: $scope.nodeUrl,
                    data: {
                        jsonrpc: "2.0",
                        method: "eth_getBlockByNumber",
                        params: [typeof blockId === 'number' ? '0x' + blockId.toString(16) : blockId, true],
                        id: 1
                    }
                }).then(function(response) {
                    $scope.loading = false;
                    if (response.data && response.data.result) {
                        $scope.blockDetail = response.data.result;
                    } else {
                        alert('åŒºå—ä¸å­˜åœ¨');
                    }
                }).catch(function(error) {
                    $scope.loading = false;
                    alert('è·å–åŒºå—å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                });
            };
            
            // æŸ¥çœ‹åœ°å€
            $scope.viewAddress = function(address) {
                console.log('æŸ¥çœ‹åœ°å€:', address);
                alert('åœ°å€åŠŸèƒ½å¼€å‘ä¸­: ' + address);
            };
            
            // è¿”å›é¦–é¡µ
            $scope.goHome = function() {
                $scope.viewMode = 'home';
                $scope.checkConnection();
            };
            
            // æ˜¾ç¤ºè¿æ¥è­¦å‘Š
            $scope.showConnectionAlert = function() {
                // ä½¿ç”¨ç®€å•çš„alertè€Œä¸æ˜¯æ¨¡æ€æ¡†ï¼Œé¿å…jQueryä¾èµ–
                var message = 'æ— æ³•è¿æ¥åˆ°ç§æœ‰é“¾èŠ‚ç‚¹ ' + $scope.nodeUrl + '\n\n' +
                             'è¯·ç¡®ä¿:\n' +
                             '1. GethèŠ‚ç‚¹æ­£åœ¨è¿è¡Œ\n' +
                             '2. RPCåœ°å€æ­£ç¡®\n' +
                             '3. Gethå¯åŠ¨äº† --http å‚æ•°\n' +
                             '4. å…è®¸è·¨åŸŸè®¿é—®';
                
                if (confirm(message + '\n\næ˜¯å¦é‡è¯•è¿æ¥?')) {
                    $scope.checkConnection();
                }
            };
            
            // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥è¿æ¥
            $timeout(function() {
                console.log('å¼€å§‹åˆå§‹è¿æ¥æ£€æŸ¥...');
                $scope.checkConnection();
            }, 1000);
            
            // å®šæ—¶æ£€æŸ¥è¿æ¥
            var checkInterval = setInterval(function() {
                if ($scope.connected) {
                    $scope.checkConnection();
                }
            }, 30000);
            
            // æ¸…ç†å®šæ—¶å™¨
            $scope.$on('$destroy', function() {
                clearInterval(checkInterval);
            });
        }
    ]);
    
    // å¯åŠ¨åº”ç”¨
    angular.element(document).ready(function() {
        console.log('æ–‡æ¡£å°±ç»ªï¼Œå¯åŠ¨Angularåº”ç”¨...');
        angular.bootstrap(document, ['ethExplorer']);
        console.log('âœ… åº”ç”¨å¯åŠ¨æˆåŠŸ');
    });
    
    console.log('=== åº”ç”¨åˆå§‹åŒ–å®Œæˆ ===');
})();

// ç®€å•çš„åŠ è½½çŠ¶æ€æ ·å¼
document.addEventListener('DOMContentLoaded', function() {
    // æ·»åŠ spinneræ ·å¼
    var style = document.createElement('style');
    style.textContent = `
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }
    `;
    document.head.appendChild(style);
});
</script>

</body>
</html>